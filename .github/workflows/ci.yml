name: CI

on:
  pull_request:
    branches:
      - main
      - master
  push:
    branches:
      - main
      - master

permissions:
  contents: read

jobs:
  test:
    name: Test (.NET ${{ matrix.dotnet-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        dotnet-version: ['8.0', '9.0']

    steps:
      - uses: actions/checkout@v6

      - name: Setup .NET ${{ matrix.dotnet-version }}
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ matrix.dotnet-version }}

      - name: Display dotnet version
        run: dotnet --version

      - name: Install dependencies
        working-directory: ./src
        run: dotnet restore logzio-dotnet.sln

      - name: Build
        working-directory: ./src
        run: dotnet build logzio-dotnet.sln --configuration Release --no-restore

      - name: Run Unit Tests with Coverage
        working-directory: ./src
        run: |
          dotnet test ./UnitTests/UnitTests.csproj \
            --configuration Release \
            --no-build \
            --framework net${{ matrix.dotnet-version }} \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults \
            --logger "trx;LogFileName=unit-tests.trx"

      - name: Run Integration Tests
        working-directory: ./src
        run: |
          dotnet test ./IntegrationTests/IntegrationTests.csproj \
            --configuration Release \
            --no-build \
            --framework net${{ matrix.dotnet-version }} \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults \
            --logger "trx;LogFileName=integration-tests.trx"

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: test-results-${{ matrix.dotnet-version }}
          path: ./src/TestResults/
          retention-days: 7

  e2e-integration:
    name: Integration Tests
    needs: [test]
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    env:
      ENV_ID: e2e-${{ github.run_id }}-${{ github.run_attempt }}

    steps:
      - uses: actions/checkout@v6

      - name: Setup .NET 9.0
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '9.0'

      - name: Install dependencies
        working-directory: ./src
        run: dotnet restore logzio-dotnet.sln

      - name: Build
        working-directory: ./src
        run: dotnet build logzio-dotnet.sln --configuration Release --no-restore

      - name: Run Integration Tests
        working-directory: ./src
        run: |
          dotnet test ./IntegrationTests/IntegrationTests.csproj \
            --configuration Release \
            --no-build \
            --framework net9.0 \
            --logger "console;verbosity=detailed" || true

  ci-success:
    name: CI Success
    needs: [test, e2e-integration]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check job results
        run: |
          if [[ "${{ needs.test.result }}" != "success" ]]; then
            echo "Test job failed"
            exit 1
          fi
          if [[ "${{ needs.e2e-integration.result }}" != "success" && "${{ needs.e2e-integration.result }}" != "skipped" ]]; then
            echo "E2E integration job failed"
            exit 1
          fi
          echo "All required jobs passed!"
